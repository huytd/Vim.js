<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
</head>
<body>
<div style="width: 100%">
<textarea id="text" rows="200" style="background: #333;color: #eee;font-size: 16px;;width:100%;word-break: normal;overflow:  ;overflow-x: scroll;">
public function getRecords()
    {
        $vars = [];
        $vars['title'] = '我的上课记录 - 个人中心';
        $vars['personal_center_menu'] = [
            'name' => '上课记录',
            'breadcrumbs' => [
                '上课记录' => '/student/records',
            ],
        ];
        $orders = Order::where('user_id', $this->user->id)->where('subject_id', '>', 0)->get();
        $lessons = new Collection([]);
        foreach ($orders as $order) {
            $temp = $order->lessons()->orderBy('start_time', 'desc')->get();
            $lessons = $lessons->merge($temp);
        }
        $lessons = $lessons->all();
        $lessons_before = [];
        $lessons_after = [];
        foreach ($lessons as $lesson) {
            if ($lesson->is_finished && $lesson->pivot->is_comment) {
                $lessons_before[] = $lesson;
            } else {
                $lessons_after[] = $lesson;
            }
        }
        $lessons = array_merge(Lesson::quick_sort($lessons_after), $lessons_before);
        $current = Input::get('page', 1) - 1;
        $matches = array_slice($lessons, $current * 15, 15);
        $vars['items'] = new Paginator($matches, count($lessons), 15, Input::get('page', 1), ['path'=>'/'.Request::path()]);
        return view('v3.site.student.records', $vars);
}
</textarea>
</div>
</body>

<script>

</script>
<script src="vim.js"></script>
<script type="text/javascript">
//    var text = document.getElementById('text');
//    var range = text.setSelectionRange(0,1);
//    var range = text.setSelectionRange(5,6);
</script>
<script type="text/javascript">
    window.vim = (function () {

        const COMMAND_MODE = 1;
        const INPUT_MODE   = 2;

        var currentMode = COMMAND_MODE;

        var v;

        function _init(config) {
            v = new Vim(config);
            _bind_key(config.el);
            config.el.onclick = function (e) {
                v.resetCursorByMourse = true;
            }
        }

        function _bind_key(el) {
            el.onkeydown = _key_down;
//            el.onkeyup = _key_up;
        }

        function _key_down(e) {
            var ev = e || window.event || event;
            var code = ev.keyCode || ev.which || ev.charCode || undefined;
            console.log('code:'+code);
            if (ev.preventDefault) {
                ev.preventDefault();
            } else {
                ev.returnValue = false;
            }
            _controller(code);
            return false;
        }

        function _key_up(e) {
            var ev = e || event || window.event;
            var currentKey = ev.keyCode || ev.which || ev.charCode;
            console.log('UP, code:' + currentKey);
            if (ev.preventDefault) {
                ev.preventDefault();
            } else {
                ev.returnValue = false;
            }
            _controller(currentKey);
            return false;
        }

        function _controller(keyCode) {
            switch (keyCode) {
                case  27 :
                    currentMode = COMMAND_MODE;
                    break;
                case 73 ://key:i
                    currentMode = INPUT_MODE;
                    break;
                case 74 :
                    v.selectPrevCharacter();
                    break;
                case 76 ://key:l
                    v.selectNextCharacter();
                    break;
                default :
                    break;
            }
        }

        function Vim(config) {
            this.el = config.el;
            this.resetCursorByMourse = true;
        }

        Vim.prototype.cursorPosition = function() {
            var el = this.el;
            if (document.selection) {
                el.focus();
                var ds = document.selection;
                var range = ds.createRange();
                var stored_range = range.duplicate();
                stored_range.moveToElementText(el);
                stored_range.setEndPoint("EndToEnd", range);
                el.selectionStart = stored_range.text.length - range.text.length;
                el.selectionEnd = el.selectionStart + range.text.length;
                return el.selectionStart;
            } else {
                return el.selectionStart
            }
        };

        Vim.prototype.select = function(start, end) {
            var el = this.el;
            if(document.selection){
                var range = el.createTextRange();
                range.moveEnd('character', -el.value.length);
                range.moveEnd('character', end);
                range.moveStart('character', start);
                range.select();
            }else{
                el.setSelectionRange(start, end);
                el.focus();
            }
        };

        Vim.prototype.selectNextCharacter = function () {
            var currentCursorPosition = this.cursorPosition();
            console.log((currentCursorPosition+1) + ' - ' + (currentCursorPosition+2));
            if (this.resetCursorByMourse) {
                this.resetCursorByMourse = false;
                this.select(currentCursorPosition, currentCursorPosition+1);
            } else {
                this.select(currentCursorPosition+1, currentCursorPosition+2);
            }
        };

        Vim.prototype.selectPrevCharacter = function () {
            var currentCursorPosition = this.cursorPosition();
            console.log((currentCursorPosition-1) + ' - ' + (currentCursorPosition));
            if (currentCursorPosition-1 < 0) {
                return false;
            }
            this.select(currentCursorPosition-1, currentCursorPosition);
            if (currentCursorPosition == 0) {
                this.resetCursorByMourse = true;
            }
        };

        return {
            applyTo: function(selector) {
                var inputArea = document.querySelector(selector);
                var config = {
                   el:inputArea
                };
                _init(config);

            }

        };
    }());

    vim_test.applyTo({
        id      : "text",
        msg     : function(msg){
            alert('msg:' + msg);
        }
    });
</script>
</html>